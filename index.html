<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cromosol Park Analyzer v9.6</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' }
            }
          }
        }
      }
    </script>

    <!-- Styles -->
    <style>
      .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .animate-in { animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
      th.sortable:hover { background-color: #f1f5f9; cursor: pointer; user-select: none; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "xlsx": "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs",
    "@google/genai": "https://esm.run/@google/genai",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>

    <!-- Polyfill -->
    <script>window.process = { env: { API_KEY: '' } };</script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as XLSX from 'xlsx';
        import { GoogleGenAI } from '@google/genai';

        // --- CONSTANTS ---
        const PARQUE_EMBEBIDO = [{"IDMODELO": 99, "MODELO": "GOL G4 2006 - 2014", "MARCA": "VOLKSWAGEN", "DESDE": 2006, "HASTA": 2014, "Clasificacion": "AA", "Parque": 325417, "Orden": 1}, {"IDMODELO": 1983, "MODELO": "HILUX 2019 - 2021", "MARCA": "TOYOTA", "DESDE": 2019, "HASTA": 2021, "Clasificacion": "AA", "Parque": 237459, "Orden": 2}, {"IDMODELO": 609, "MODELO": "CLASSIC 2010 - 2016", "MARCA": "CHEVROLET", "DESDE": 2010, "HASTA": 2016, "Clasificacion": "AA", "Parque": 217113, "Orden": 3}]; 

        // --- UTILS ---
        const smartGet = (row, terms) => {
            if (!row) return null;
            const keys = Object.keys(row);
            // 1. Exact match
            for (let term of terms) {
                if (row[term] !== undefined) return row[term];
            }
            // 2. Case insensitive & Trim match
            for (let key of keys) {
                const k = key.toLowerCase().trim();
                for (let term of terms) {
                    if (k === term.toLowerCase()) return row[key];
                }
            }
            // 3. Partial match (careful with this one, verify if needed)
            for (let key of keys) {
                const k = key.toLowerCase().trim();
                for (let term of terms) {
                    if (k.includes(term.toLowerCase())) return row[key];
                }
            }
            return null;
        };

        // --- COMPONENTS ---

        const ImageGenerator = ({ vehicleName, partName }) => {
            const [frontImage, setFrontImage] = useState(null);
            const [detailImage, setDetailImage] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [zoomedImage, setZoomedImage] = useState(null);

            useEffect(() => { if (vehicleName) generateImages(); }, [vehicleName, partName]);

            const generateSingleImage = async (prompt) => {
                try {
                    const apiKey = process.env.API_KEY || (window.aistudio ? await window.aistudio.getApiKey() : '');
                    if (!apiKey) throw new Error("Falta API Key");
                    const ai = new GoogleGenAI({ apiKey });
                    const response = await ai.models.generateContent({ model: 'gemini-2.5-flash-image', contents: { parts: [{ text: prompt }] } });
                    if (response.candidates?.[0]?.content?.parts) {
                        for (const part of response.candidates[0].content.parts) {
                            if (part.inlineData) return `data:image/png;base64,${part.inlineData.data}`;
                        }
                    }
                    return null;
                } catch (e) { console.error("GenAI Error:", e); return null; }
            };

            const generateImages = async () => {
                setLoading(true); setError(null); setFrontImage(null); setDetailImage(null);
                try {
                    const frontPrompt = `A high quality, realistic studio photo of the front view of a ${vehicleName} car, white background.`;
                    const promises = [generateSingleImage(frontPrompt)];
                    if (partName && partName !== 'ALL') {
                        const detailPrompt = `A high quality, realistic close-up photo of the ${partName} of a ${vehicleName} car, zoomed in, white background.`;
                        promises.push(generateSingleImage(detailPrompt));
                    } else { promises.push(Promise.resolve(null)); }
                    const [front, detail] = await Promise.all(promises);
                    if (front) setFrontImage(front);
                    if (detail) setDetailImage(detail);
                    if (!front && !detail) setError("No se pudieron generar im√°genes (Verifica API Key).");
                } catch (err) { setError("Error al conectar con IA."); } finally { setLoading(false); }
            };

            return (
                <div className="space-y-4">
                    {loading && <div className="h-40 bg-slate-100 rounded flex items-center justify-center text-xs text-slate-500 animate-pulse">Generando im√°genes...</div>}
                    {error && <div className="text-red-500 text-xs text-center p-2 bg-red-50 rounded border border-red-100">{error} <button onClick={generateImages} className="underline ml-2 font-bold">Reintentar</button></div>}
                    {!loading && !error && (
                        <>
                            <div className="relative group rounded-lg overflow-hidden border border-slate-200 shadow-sm bg-white cursor-zoom-in hover:shadow-md transition-all" onClick={() => frontImage && setZoomedImage(frontImage)}>
                                {frontImage ? <img src={frontImage} className="w-full h-48 object-cover" /> : <div className="h-48 flex items-center justify-center text-xs text-slate-400">Sin imagen frontal</div>}
                                {frontImage && <div className="absolute bottom-0 w-full bg-black/50 text-white text-[10px] p-1 text-center backdrop-blur-sm">Vista Frontal (IA)</div>}
                            </div>
                            {partName && partName !== 'ALL' && (
                                <div className="relative group rounded-lg overflow-hidden border border-slate-200 shadow-sm bg-white cursor-zoom-in hover:shadow-md transition-all" onClick={() => detailImage && setZoomedImage(detailImage)}>
                                    {detailImage ? <img src={detailImage} className="w-full h-48 object-cover" /> : <div className="h-48 flex items-center justify-center text-xs text-slate-400">Sin detalle</div>}
                                    {detailImage && <div className="absolute bottom-0 w-full bg-black/50 text-white text-[10px] p-1 text-center backdrop-blur-sm">Detalle: {partName}</div>}
                                </div>
                            )}
                        </>
                    )}
                    {zoomedImage && (
                        <div className="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 cursor-zoom-out" onClick={() => setZoomedImage(null)}>
                            <img src={zoomedImage} className="max-w-full max-h-full rounded shadow-2xl" />
                        </div>
                    )}
                </div>
            );
        };

        const VideoGenerator = ({ vehicleName, partName }) => {
            const [loading, setLoading] = useState(false);
            const [videoUri, setVideoUri] = useState(null);
            const [status, setStatus] = useState('');
            const [progress, setProgress] = useState(0);

            const generateCommercial = async () => {
                setLoading(true); setStatus('Inicializando Veo 3...'); setProgress(5);
                try {
                    const apiKey = process.env.API_KEY || (window.aistudio ? await window.aistudio.getApiKey() : '');
                    const ai = new GoogleGenAI({ apiKey });
                    const prompt = `Cinematic commercial. Professional presenter showing a ${partName} for a ${vehicleName} in a modern auto parts showroom. 4k, photorealistic.`;
                    let operation = await ai.models.generateVideos({ model: 'veo-3.1-fast-generate-preview', prompt: prompt, config: { numberOfVideos: 1, resolution: '720p', aspectRatio: '16:9' } });
                    setStatus('Generando video...');
                    let attempts = 0;
                    while (!operation.done && attempts < 60) {
                        attempts++; setProgress(Math.min(10 + (attempts * 2), 90));
                        await new Promise(r => setTimeout(r, 2000));
                        operation = await ai.operations.getVideosOperation({ operation: operation });
                    }
                    if (operation.done && operation.response?.generatedVideos?.[0]?.video?.uri) {
                        setVideoUri(`${operation.response.generatedVideos[0].video.uri}&key=${apiKey}`);
                        setProgress(100);
                    } else { setStatus('Error al generar video.'); }
                } catch (e) { setStatus('Error: ' + e.message); } finally { setLoading(false); }
            };

            return (
                <div className="mt-6 border-t pt-4">
                    <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2"><span className="text-xl">üé¨</span> Comercial TV (Veo AI)</h4>
                    {!videoUri && !loading && <div className="bg-slate-100 p-4 rounded text-center border border-slate-200"><p className="text-xs text-slate-500 mb-3">Crea un video publicitario √∫nico para este producto.</p><button onClick={generateCommercial} className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-2 rounded-full font-bold hover:shadow-lg transition-all transform hover:scale-105 text-sm">Generar Comercial</button></div>}
                    {loading && <div className="bg-slate-50 p-4 rounded text-center border border-slate-200"><div className="text-sm font-bold mb-2 text-slate-700">{status}</div><div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden"><div className="bg-purple-600 h-2 rounded-full transition-all duration-500" style={{width: `${progress}%`}}></div></div></div>}
                    {videoUri && <div className="bg-black rounded-xl overflow-hidden shadow-lg"><video src={videoUri} controls autoPlay className="w-full" /><button onClick={() => setVideoUri(null)} className="w-full bg-slate-800 text-white p-2 text-xs hover:bg-red-600 transition-colors">Cerrar Video</button></div>}
                </div>
            );
        };

        const VoiceAssistant = () => {
            const [isActive, setIsActive] = useState(false);
            return (
                <div className="fixed bottom-6 right-6 z-50">
                    <button onClick={() => setIsActive(!isActive)} className={`flex items-center gap-2 px-4 py-3 rounded-full shadow-xl font-bold transition-all transform hover:scale-105 ${isActive ? 'bg-red-500 text-white animate-pulse' : 'bg-brand-600 text-white'}`}>
                        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                        {isActive ? 'Escuchando...' : 'Asistente de Voz'}
                    </button>
                </div>
            );
        };

        const ProductModal = ({ data, onClose, availableTeams }) => {
            const partName = data.productos.length > 0 ? data.productos[0].nivel2 : undefined;
            const [tasks, setTasks] = useState({});
            const [editingId, setEditingId] = useState(null);
            const [newTask, setNewTask] = useState({ text: '', team: availableTeams[0] || 'Ventas' });
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });

            useEffect(() => {
                const stored = localStorage.getItem('cromosol_tasks');
                if (stored) setTasks(JSON.parse(stored));
            }, []);

            const saveTask = (productCode) => {
                const updated = { ...tasks, [productCode]: { ...newTask, date: new Date().toLocaleDateString() } };
                setTasks(updated);
                localStorage.setItem('cromosol_tasks', JSON.stringify(updated));
                setEditingId(null);
                setNewTask({ text: '', team: availableTeams[0] || 'Ventas' });
            };

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const sortedProducts = useMemo(() => {
                let items = [...data.productos];
                if (sortConfig.key !== null) {
                    items.sort((a, b) => {
                        let aVal, bVal;
                        switch(sortConfig.key) {
                            case 'precio': 
                                aVal = parseFloat(a.precio || 0); bVal = parseFloat(b.precio || 0); break;
                            case 'stock': 
                                aVal = parseFloat(a.stock || 0); bVal = parseFloat(b.stock || 0); break;
                            case 'venta': 
                                aVal = parseFloat(a.venta || 0); bVal = parseFloat(b.venta || 0); break;
                            default: 
                                aVal = a[sortConfig.key] || ''; bVal = b[sortConfig.key] || ''; break;
                        }
                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return items;
            }, [data.productos, sortConfig]);

            const getSortIcon = (key) => {
                if (sortConfig.key !== key) return <span className="ml-1 text-slate-300 opacity-0 group-hover:opacity-50">‚Üï</span>;
                return <span className="ml-1 text-brand-600">{sortConfig.direction === 'asc' ? '‚ñ≤' : '‚ñº'}</span>;
            };

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl max-w-[95vw] w-full max-h-[90vh] flex flex-col overflow-hidden animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
                        <div className="bg-brand-600 p-6 flex justify-between items-start shrink-0 text-white">
                            <div><h3 className="text-2xl font-bold mb-1">Detalle: {data.marca} {data.modelo}</h3><p className="text-brand-100 text-sm opacity-90">{data.columna.replace('|', ' ‚Ä∫ ')}</p></div>
                            <button onClick={onClose} className="hover:bg-white/20 p-2 rounded-full transition-colors"><svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                        </div>
                        <div className="flex-1 overflow-hidden p-0 flex flex-col lg:flex-row">
                            <div className="w-full lg:w-1/3 bg-slate-50 p-6 border-r overflow-y-auto custom-scrollbar">
                                <ImageGenerator vehicleName={`${data.marca} ${data.modelo}`} partName={partName} />
                                <VideoGenerator vehicleName={`${data.marca} ${data.modelo}`} partName={partName} />
                            </div>
                            <div className="w-full lg:w-2/3 overflow-y-auto bg-white custom-scrollbar p-6">
                                <table className="w-full text-left text-sm border-collapse">
                                    <thead className="bg-slate-50 text-slate-600 sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th className="px-4 py-3 border-b sortable group" onClick={()=>requestSort('equivalencia')}>C√≥digo {getSortIcon('equivalencia')}</th>
                                            <th className="px-4 py-3 border-b text-center sortable group" onClick={()=>requestSort('proveedor')}>Prov. {getSortIcon('proveedor')}</th>
                                            <th className="px-4 py-3 border-b w-1/3 sortable group" onClick={()=>requestSort('descripcion')}>Descripci√≥n {getSortIcon('descripcion')}</th>
                                            <th className="px-4 py-3 border-b text-center sortable group" onClick={()=>requestSort('precio')}>Precio {getSortIcon('precio')}</th>
                                            <th className="px-4 py-3 border-b text-center sortable group" onClick={()=>requestSort('stock')}>Stock {getSortIcon('stock')}</th>
                                            <th className="px-4 py-3 border-b text-center sortable group" onClick={()=>requestSort('venta')}>Venta Avg {getSortIcon('venta')}</th>
                                            <th className="px-4 py-3 border-b">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {sortedProducts.map((p, i) => {
                                            const esProv3 = Number(p.proveedor) === 3;
                                            const task = tasks[p.equivalencia];
                                            const isEditing = editingId === p.equivalencia;
                                            const precio = p.precio;
                                            return (
                                                <tr key={i} className={`hover:bg-slate-50 ${esProv3 ? 'bg-orange-50/40' : ''}`}>
                                                    <td className="px-4 py-3"><div className="font-mono font-bold text-brand-600">{p.equivalencia}</div><div className="text-xs text-slate-400">{p.numero}</div></td>
                                                    <td className="px-4 py-3 text-center">{esProv3 ? <span className="bg-orange-100 text-orange-800 px-2 py-0.5 rounded text-xs font-bold">{p.proveedor} ‚ö†Ô∏è</span> : p.proveedor}</td>
                                                    <td className="px-4 py-3 text-slate-600 whitespace-normal text-xs leading-relaxed">{p.descripcion}</td>
                                                    <td className="px-4 py-3 text-center font-mono font-semibold text-green-700">{precio ? `$${parseFloat(precio).toLocaleString('es-AR', {minimumFractionDigits: 2})}` : '-'}</td>
                                                    <td className="px-4 py-3 text-center font-mono font-semibold">{p.stock !== null && p.stock !== undefined ? p.stock : '-'}</td>
                                                    <td className="px-4 py-3 text-center font-mono font-semibold">{p.venta !== null && p.venta !== undefined ? parseFloat(p.venta).toLocaleString('es-AR', {minimumFractionDigits: 2}) : '-'}</td>
                                                    <td className="px-4 py-3 relative">
                                                        {isEditing ? (
                                                            <div className="flex flex-col gap-2 bg-white p-3 border rounded-lg shadow-xl z-20 absolute right-0 min-w-[200px]">
                                                                <input type="text" placeholder="Tarea..." className="border p-2 text-xs rounded w-full" value={newTask.text} onChange={e=>setNewTask({...newTask, text:e.target.value})} autoFocus />
                                                                <select className="border p-2 text-xs rounded w-full bg-slate-50" value={newTask.team} onChange={e=>setNewTask({...newTask, team:e.target.value})}>
                                                                    {availableTeams.map(t => <option key={t} value={t}>{t}</option>)}
                                                                </select>
                                                                <div className="flex gap-2 mt-1"><button onClick={()=>saveTask(p.equivalencia)} className="bg-green-500 text-white px-3 py-1 rounded text-xs flex-1 hover:bg-green-600">Guardar</button><button onClick={()=>setEditingId(null)} className="bg-slate-200 px-3 py-1 rounded text-xs flex-1 hover:bg-slate-300">Cancelar</button></div>
                                                            </div>
                                                        ) : (
                                                            task ? <div onClick={()=>setEditingId(p.equivalencia)} className="cursor-pointer bg-yellow-50 border border-yellow-200 rounded p-2 text-xs hover:bg-yellow-100"><div className="font-bold text-yellow-800">{task.text}</div><div className="text-[10px] text-yellow-600 mt-1 flex justify-between"><span>{task.team}</span><span>{task.date}</span></div></div> : <button onClick={()=>setEditingId(p.equivalencia)} className="text-slate-400 hover:text-brand-600 text-xl transition-transform hover:scale-110 p-1" title="Agregar Tarea">üìù</button>
                                                        )}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PolicyAnalyzer = ({ parque, productsByModelId, availableTeams }) => {
            const { useMemo, useState } = React;
            const [filtroSegmento, setFiltroSegmento] = useState(null);
            const [rules, setRules] = useState({ vintageLimit: 2000, modernLimit: 2015 });
            const [showRuleEditor, setShowRuleEditor] = useState(false);

            const classifyQuality = (prov) => {
                const pStr = String(prov).toUpperCase();
                if (pStr.includes('ORIGINAL') || pStr.includes('OEM')) return 'ORIGINAL';
                if (['1', '2', 'BOSCH', 'SKF', 'VALEO'].some(x => pStr.includes(x))) return 'PREMIUM';
                return 'STANDARD';
            };

            const createAction = (type, text) => {
                let team = 'General';
                if (type === 'ADD') team = 'Compras / Comex';
                if (type === 'REMOVE') team = 'Ventas / Productos';
                if (type === 'EVAL') team = 'Ventas / Comercial';
                if (type === 'DEV') team = 'Desarrollo';
                return { type, text, team };
            };

            const results = useMemo(() => {
                return parque.filter(m => m.Clasificacion === 'AA').map(m => {
                    const year = m.HASTA;
                    const products = productsByModelId[m.IDMODELO] || [];
                    
                    let original = 0, premium = 0, standard = 0;
                    const premiums = [];
                    const originals = [];

                    products.forEach(p => {
                        const q = classifyQuality(p.Proveedor);
                        if (q === 'ORIGINAL') { original++; originals.push(p); }
                        else if (q === 'PREMIUM') { premium++; premiums.push(p); }
                        else standard++;
                    });

                    const actions = [];
                    let estado = 'OK', segmento = '';
                    
                    // --- REGLAS AVANZADAS V9 ---

                    // 1. Canibalizaci√≥n
                    if (premium > 0 && original > 0) {
                        actions.push(createAction('REMOVE', 'Eliminar Originales (Ya existe Premium)'));
                        estado = 'WARNING';
                    }

                    // 2. An√°lisis de "Primer"
                    if (premium > 0) {
                        premiums.forEach(p => {
                            const desc = (p['Descripci√≥n'] || '').toUpperCase();
                            const venta = parseFloat(smartGet(p, ['Venta Promedio', 'Venta', 'Avg']) || 0);
                            
                            if ((desc.includes('PRIMER') || desc.includes('PINTAR')) && venta < 3) {
                                actions.push(createAction('EVAL', `Revisar ${p.Equivalencia} (Primer con baja venta)`));
                                if (estado !== 'CRITICAL') estado = 'WARNING';
                            }
                        });
                    }

                    // 3. Reglas por Antig√ºedad
                    if (year <= rules.vintageLimit) {
                        segmento = 'Antiguo';
                        if (standard === 0 && premium === 0) { actions.push(createAction('DEV', 'Desarrollar Econ√≥mico')); estado = 'CRITICAL'; }
                        else if (standard === 0 && premium > 0) { actions.push(createAction('EVAL', 'Evaluar alt. Est√°ndar (Costo)')); }
                    } else if (year <= rules.modernLimit) {
                        segmento = 'Moderno';
                        if (premium === 0 && standard === 0) { actions.push(createAction('ADD', 'Sin Cobertura: Buscar Prov.')); estado = 'CRITICAL'; }
                        else if (premium === 0) { actions.push(createAction('ADD', 'Falta Premium')); }
                    } else {
                        segmento = 'Nuevo';
                        if (premium === 0 && original === 0) { actions.push(createAction('ADD', 'Falta Premium/Original')); estado = 'CRITICAL'; }
                        else if (standard > 0) { actions.push(createAction('REMOVE', 'Eliminar Est√°ndar (Riesgo Marca)')); estado = 'WARNING'; }
                    }

                    if (actions.length === 0) actions.push(createAction('OK', 'Mix Correcto'));
                    return { ...m, segmento, mix: { orig: original, prem: premium, std: standard }, estado, actions };
                }).sort((a, b) => (a.estado === 'CRITICAL' ? -1 : 1));
            }, [parque, productsByModelId, rules]);

            const filtered = filtroSegmento ? results.filter(r => r.segmento === filtroSegmento) : results;

            const exportExcel = () => {
                const ws = XLSX.utils.json_to_sheet(filtered.map(r => ({ Marca: r.MARCA, Modelo: r.MODELO, Segmento: r.segmento, Estado: r.estado, Acciones: r.actions.map(a => a.text).join(' | ') })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Analisis");
                XLSX.writeFile(wb, "Analisis.xlsx");
            };

            const Card = ({ title, color, count, onClick, active, subtitle }) => (
                <div onClick={onClick} className={`p-4 rounded-xl border cursor-pointer transition-all ${active ? `bg-${color}-100 border-${color}-500 ring-2 ring-${color}-200 scale-105` : `bg-${color}-50 border-${color}-200 hover:shadow-md`}`}>
                    <h3 className={`font-bold text-${color}-800 text-lg`}>{title}</h3>
                    <p className={`text-xs text-${color}-600 mb-2 font-mono`}>{subtitle}</p>
                    <p className={`text-sm text-${color}-600 font-bold`}>{count} Modelos</p>
                </div>
            );

            const renderActionTag = (action) => {
                const styles = { ADD: 'bg-emerald-100 text-emerald-800 border-emerald-200', REMOVE: 'bg-rose-100 text-rose-800 border-rose-200', EVAL: 'bg-amber-100 text-amber-800 border-amber-200', DEV: 'bg-violet-100 text-violet-800 border-violet-200', OK: 'bg-slate-100 text-slate-600 border-slate-200' };
                return <div className={`inline-block px-2 py-1 rounded text-xs font-bold mr-1 mb-1 border ${styles[action.type] || styles.OK}`}>{action.text} <span className="font-normal text-slate-500 opacity-75">({action.team})</span></div>;
            };

            return (
                <div className="space-y-6 animate-in fade-in">
                    <div className="flex justify-between items-center flex-wrap gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">Motor de Pol√≠tica (AI)</h2>
                            <p className="text-sm text-slate-500">Reglas: Antiguo &le; {rules.vintageLimit}, Moderno &le; {rules.modernLimit}</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowRuleEditor(!showRuleEditor)} className="bg-blue-100 text-blue-700 hover:bg-blue-200 px-4 py-2 rounded-lg font-semibold flex items-center gap-2">‚öôÔ∏è Editar Reglas</button>
                            <button onClick={exportExcel} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow-sm font-semibold flex items-center gap-2">üì• Exportar</button>
                        </div>
                    </div>

                    {showRuleEditor && (
                        <div className="bg-white p-4 border rounded-xl shadow-lg mb-4 animate-in fade-in">
                            <h3 className="font-bold mb-3">Configurar Cortes de Antig√ºedad</h3>
                            <div className="flex gap-4 items-end">
                                <div><label className="text-xs font-bold text-slate-500">Limite Antiguo</label><input type="number" className="border p-2 rounded w-full" value={rules.vintageLimit} onChange={e => setRules({...rules, vintageLimit: Number(e.target.value)})} /></div>
                                <div><label className="text-xs font-bold text-slate-500">Limite Moderno</label><input type="number" className="border p-2 rounded w-full" value={rules.modernLimit} onChange={e => setRules({...rules, modernLimit: Number(e.target.value)})} /></div>
                                <button onClick={() => setShowRuleEditor(false)} className="bg-slate-800 text-white px-4 py-2 rounded font-bold">Aplicar</button>
                            </div>
                        </div>
                    )}

                    <div className="grid md:grid-cols-3 gap-4">
                        <Card title="Antiguo" subtitle={`Hasta ${rules.vintageLimit}`} color="amber" count={results.filter(r => r.segmento === 'Antiguo').length} onClick={() => setFiltroSegmento(filtroSegmento === 'Antiguo' ? null : 'Antiguo')} active={filtroSegmento === 'Antiguo'} />
                        <Card title="Moderno" subtitle={`${rules.vintageLimit + 1} - ${rules.modernLimit}`} color="sky" count={results.filter(r => r.segmento === 'Moderno').length} onClick={() => setFiltroSegmento(filtroSegmento === 'Moderno' ? null : 'Moderno')} active={filtroSegmento === 'Moderno'} />
                        <Card title="Nuevo" subtitle={`${rules.modernLimit + 1} +`} color="purple" count={results.filter(r => r.segmento === 'Nuevo').length} onClick={() => setFiltroSegmento(filtroSegmento === 'Nuevo' ? null : 'Nuevo')} active={filtroSegmento === 'Nuevo'} />
                    </div>

                    <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 text-slate-600"><tr><th className="p-3">Modelo</th><th className="p-3 text-center">A√±o</th><th className="p-3 text-center">Mix (O/P/S)</th><th className="p-3 text-center">Estado</th><th className="p-3">Acciones</th></tr></thead>
                            <tbody className="divide-y divide-slate-100">
                                {filtered.map((r, i) => (
                                    <tr key={i} className="hover:bg-slate-50">
                                        <td className="p-3"><div className="font-bold text-slate-700">{r.MODELO}</div></td>
                                        <td className="p-3 text-center text-slate-500">{r.HASTA}</td>
                                        <td className="p-3 text-center font-mono text-xs"><span className="bg-purple-100 text-purple-800 px-1 rounded">{r.mix.orig}</span>/<span className="bg-blue-100 text-blue-800 px-1 rounded">{r.mix.prem}</span>/<span className="bg-amber-100 text-amber-800 px-1 rounded">{r.mix.std}</span></td>
                                        <td className="p-3 text-center"><span className={`px-2 py-1 rounded text-xs font-bold ${r.estado === 'CRITICAL' ? 'bg-red-100 text-red-800' : r.estado === 'WARNING' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>{r.estado}</span></td>
                                        <td className="p-3">{r.actions.map((a, j) => <React.Fragment key={j}>{renderActionTag(a)}</React.Fragment>)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const HelpModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 p-4" onClick={onClose}>
                <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full" onClick={e => e.stopPropagation()}>
                    <h3 className="text-xl font-bold mb-4">Plantillas de Datos</h3>
                    <p className="text-slate-500 text-sm mb-6">Descarga los archivos Excel base para comenzar.</p>
                    <div className="space-y-3">
                        <button onClick={() => { const ws = XLSX.utils.json_to_sheet([{"Stmvid": "ID", "Nivel 1": "A", "Nivel 2": "B", "Proveedor": "1", "Equivalencia": "COD", "Numero": "NUM", "Stock Actual": 10, "Venta Promedio": 5, "Precio": 100}]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Prod"); XLSX.writeFile(wb, "Plantilla_Productos.xlsx"); }} className="w-full bg-green-50 border border-green-200 text-green-700 p-3 rounded font-bold hover:bg-green-100 flex items-center justify-center gap-2">üìä Descargar Plantilla Productos</button>
                        <button onClick={() => { const ws = XLSX.utils.json_to_sheet(PARQUE_EMBEBIDO); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Park"); XLSX.writeFile(wb, "Plantilla_Parque.xlsx"); }} className="w-full bg-blue-50 border border-blue-200 text-blue-700 p-3 rounded font-bold hover:bg-blue-100 flex items-center justify-center gap-2">üöó Descargar Plantilla Parque</button>
                    </div>
                    <button onClick={onClose} className="mt-6 w-full text-slate-500 hover:text-slate-800 text-sm font-semibold">Cerrar</button>
                </div>
            </div>
        );

        const TeamsConfigModal = ({ currentTeams, onSave, onClose }) => {
            const [newTeam, setNewTeam] = useState('');
            const [teams, setTeams] = useState(currentTeams);

            const addTeam = () => {
                if(newTeam && !teams.includes(newTeam)) {
                    setTeams([...teams, newTeam]);
                    setNewTeam('');
                }
            };

            const removeTeam = (team) => {
                setTeams(teams.filter(t => t !== team));
            };

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4">Configurar Equipos</h3>
                        <div className="flex gap-2 mb-4">
                            <input type="text" className="border p-2 rounded flex-1 text-sm" placeholder="Nombre Equipo" value={newTeam} onChange={e=>setNewTeam(e.target.value)} />
                            <button onClick={addTeam} className="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold">+</button>
                        </div>
                        <ul className="space-y-2 mb-4 max-h-48 overflow-y-auto">
                            {teams.map(t => (
                                <li key={t} className="flex justify-between items-center bg-slate-50 p-2 rounded text-sm">
                                    {t}
                                    <button onClick={() => removeTeam(t)} className="text-red-500 hover:text-red-700">√ó</button>
                                </li>
                            ))}
                        </ul>
                        <button onClick={() => onSave(teams)} className="w-full bg-slate-800 text-white py-2 rounded font-bold text-sm">Guardar Cambios</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [hasKey, setHasKey] = useState(false);
            const [products, setProducts] = useState(null);
            const [park, setPark] = useState(PARQUE_EMBEBIDO);
            const [view, setView] = useState('TABLE');
            const [modalData, setModalData] = useState(null);
            const [filtroCat, setFiltroCat] = useState('TODOS');
            const [filtroMarca, setFiltroMarca] = useState('TODOS');
            const [showN1, setShowN1] = useState(true);
            const [showN2, setShowN2] = useState(true);
            const [showHelp, setShowHelp] = useState(false);
            const [showTeamsConfig, setShowTeamsConfig] = useState(false);
            const [availableTeams, setAvailableTeams] = useState(['Ventas', 'Compras', 'Producto', 'Log√≠stica']);
            
            // New State for Model Comments
            const [modelComments, setModelComments] = useState({});

            useEffect(() => {
                if (window.aistudio) window.aistudio.hasSelectedApiKey().then(setHasKey).catch(() => setHasKey(false));
                else setHasKey(true);
                
                const storedTeams = localStorage.getItem('cromosol_teams');
                if (storedTeams) setAvailableTeams(JSON.parse(storedTeams));
                
                const storedComments = localStorage.getItem('cromosol_model_comments');
                if (storedComments) setModelComments(JSON.parse(storedComments));
            }, []);

            const updateTeams = (newTeams) => {
                setAvailableTeams(newTeams);
                localStorage.setItem('cromosol_teams', JSON.stringify(newTeams));
                setShowTeamsConfig(false);
            };

            const handleModelCommentChange = (modelName, comment) => {
                const updated = { ...modelComments, [modelName]: comment };
                setModelComments(updated);
                localStorage.setItem('cromosol_model_comments', JSON.stringify(updated));
            };

            const exportTasksReport = () => {
                const stored = localStorage.getItem('cromosol_tasks');
                if (!stored) { alert('No hay tareas guardadas.'); return; }
                const tasks = JSON.parse(stored);
                const data = Object.entries(tasks).map(([code, t]) => ({ Codigo: code, Tarea: t.text, Equipo: t.team, Fecha: t.date }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Tareas");
                XLSX.writeFile(wb, "Reporte_Tareas.xlsx");
            };
            
            // Function to export the full Coverage Table
            const exportCoverageTable = (data) => {
                if (!data || !data.res) return;
                
                const rows = [];
                const sortedBrands = Object.keys(data.res).sort();
                
                sortedBrands.forEach(marca => {
                   const models = data.res[marca].sort((a, b) => (a.Orden || 999) - (b.Orden || 999));
                   models.forEach(m => {
                       const row = {
                           Marca: marca,
                           Modelo: m.MODELO,
                       };
                       
                       // Add dynamic columns
                       data.cols.forEach(c => {
                           const colName = c.replace('|', ' ');
                           row[colName] = m.counts[c] || 0;
                       });
                       
                       row['Total Productos'] = m.total;
                       row['Comentarios Estrat√©gicos'] = modelComments[m.MODELO] || '';
                       
                       rows.push(row);
                   });
                });
                
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Cobertura_Completa");
                XLSX.writeFile(wb, `Tabla_Cobertura_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const handleFile = (e, type) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, { type: 'array' });
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if (type === 'PROD') setProducts(data); else setPark(data);
                };
                reader.readAsArrayBuffer(file);
            };

            const processed = useMemo(() => {
                if (!products) return null;
                const prodMap = {};
                products.forEach(p => {
                    const id = p.Stmvid || p.IDMODELO;
                    if (!prodMap[id]) prodMap[id] = [];
                    prodMap[id].push(p);
                });
                const covered = [], missing = [];
                park.forEach(m => {
                    if (prodMap[m.IDMODELO]) covered.push({ ...m, products: prodMap[m.IDMODELO] });
                    else missing.push(m);
                });
                return { covered, missing, prodMap };
            }, [products, park]);

            const levels = useMemo(() => {
                if (!products) return { n1: [], n2: [] };
                const n1 = new Set(), n2 = new Set();
                products.forEach(p => { if (p['Nivel 1']) n1.add(p['Nivel 1']); if (p['Nivel 2']) n2.add(p['Nivel 2']); });
                return { n1: Array.from(n1).sort(), n2: Array.from(n2).sort() };
            }, [products]);

            const tableData = useMemo(() => {
                if (!processed) return null;
                let cols = [];
                if (showN1 && showN2) levels.n1.forEach(l1 => levels.n2.forEach(l2 => cols.push(`${l1}|${l2}`)));
                else if (showN1) cols = levels.n1.map(l => `${l}|ALL`);
                else if (showN2) cols = levels.n2.map(l => `ALL|${l}`);
                else cols = ['ALL|ALL'];

                const filtered = processed.covered.filter(m => (filtroCat === 'TODOS' || m.Clasificacion === filtroCat) && (filtroMarca === 'TODOS' || m.MARCA === filtroMarca));
                const res = {};
                filtered.forEach(m => {
                    if (!res[m.MARCA]) res[m.MARCA] = [];
                    const counts = {}; cols.forEach(c => counts[c] = 0);
                    const prods = {}; cols.forEach(c => prods[c] = []);
                    m.products.forEach(p => {
                        const k1 = p['Nivel 1'], k2 = p['Nivel 2'];
                        const keys = showN1 && showN2 ? [`${k1}|${k2}`] : showN1 ? [`${k1}|ALL`] : showN2 ? [`ALL|${k2}`] : ['ALL|ALL'];
                        keys.forEach(k => {
                            if (counts[k] !== undefined) {
                                counts[k]++;
                                prods[k].push({
                                    equivalencia: p.Equivalencia, numero: p.Numero, proveedor: p.Proveedor, descripcion: p['Descripci√≥n'], nivel2: k2,
                                    stock: smartGet(p, ['Stock', 'Stock Actual', 'Cantidad']),
                                    venta: smartGet(p, ['Venta Promedio', 'Venta', 'Avg']),
                                    precio: smartGet(p, ['Precio', 'Costo', 'Price'])
                                });
                            }
                        });
                    });
                    res[m.MARCA].push({ ...m, counts, prods, total: Object.values(counts).reduce((a, b) => a + b, 0) });
                });
                return { res, cols };
            }, [processed, filtroCat, filtroMarca, showN1, showN2, levels]);

            if (!hasKey) return <div className="h-screen bg-slate-50 flex items-center justify-center"><div className="bg-white p-8 rounded-xl shadow-lg text-center max-w-md"><h2 className="text-2xl font-bold text-slate-800 mb-2">Bienvenido</h2><p className="text-slate-500 mb-6">Para usar las funciones de IA (Im√°genes y Video), conecta tu cuenta.</p><button onClick={() => window.aistudio.openSelectKey().then(() => setHasKey(true))} className="bg-brand-600 hover:bg-brand-700 text-white px-6 py-3 rounded-lg font-bold shadow transition-colors w-full">Conectar Google AI</button></div></div>;

            return (
                <div className="min-h-screen pb-12 bg-slate-50">
                    <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-40 shadow-sm">
                        <div className="flex items-center gap-3"><div className="bg-brand-600 text-white p-2 rounded-lg"><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></div><h1 className="text-xl font-bold text-slate-800">Cromosol Analyzer <span className="text-brand-500 text-xs ml-1">v9.6</span></h1></div>
                        <div className="flex gap-2">
                            <label className="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg cursor-pointer font-bold text-sm flex items-center gap-2 transition-colors"><input type="file" accept=".xlsx,.xls" hidden onChange={e => handleFile(e, 'PROD')} /><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>{products ? `Productos (${products.length})` : 'Cargar Productos'}</label>
                            <label className="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg cursor-pointer font-bold text-sm transition-colors"><input type="file" accept=".xlsx,.xls" hidden onChange={e => handleFile(e, 'PARK')} />üîÑ Actualizar Parque</label>
                            <button onClick={() => setShowHelp(true)} className="bg-slate-100 hover:bg-slate-200 text-slate-700 p-2 rounded-lg transition-colors">‚ùì</button>
                        </div>
                    </header>
                    <main className="p-6 max-w-[1920px] mx-auto">
                        {!products && <div className="text-center py-24 border-2 border-dashed border-slate-300 rounded-2xl bg-white"><div className="text-6xl mb-4">üìÇ</div><h3 className="text-xl font-bold text-slate-700">Sube tu archivo de productos</h3><p className="text-slate-500 mt-2">El sistema cruzar√° autom√°ticamente tu stock con el parque automotor.</p></div>}
                        {products && processed && (
                            <>
                                <div className="bg-white p-4 rounded-xl shadow-sm border mb-6 flex flex-wrap gap-4 items-center justify-between">
                                    <div className="flex gap-4 items-center flex-wrap">
                                        <select className="border rounded-lg p-2 text-sm bg-slate-50" value={filtroMarca} onChange={e => setFiltroMarca(e.target.value)}><option value="TODOS">Todas las Marcas</option>{[...new Set(park.map(p => p.MARCA))].sort().map(m => <option key={m} value={m}>{m}</option>)}</select>
                                        <div className="flex gap-2 bg-slate-100 p-1 rounded-lg">{['TODOS', 'AA', 'A', 'B'].map(c => <button key={c} onClick={() => setFiltroCat(c)} className={`px-3 py-1.5 rounded-md font-bold text-xs transition-all ${filtroCat === c ? 'bg-white text-brand-600 shadow' : 'text-slate-500 hover:text-slate-700'}`}>{c}</button>)}</div>
                                        <div className="h-6 w-px bg-slate-200 mx-2"></div>
                                        <label className="flex gap-2 items-center text-sm font-medium text-slate-600 cursor-pointer"><input type="checkbox" className="rounded text-brand-600 focus:ring-brand-500" checked={showN1} onChange={e => setShowN1(e.target.checked)} /> Nivel 1</label>
                                        <label className="flex gap-2 items-center text-sm font-medium text-slate-600 cursor-pointer"><input type="checkbox" className="rounded text-brand-600 focus:ring-brand-500" checked={showN2} onChange={e => setShowN2(e.target.checked)} /> Nivel 2</label>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowTeamsConfig(true)} className="text-slate-500 hover:text-brand-600 text-sm font-semibold flex items-center gap-1 bg-white border border-slate-200 px-3 py-2 rounded-lg">‚öôÔ∏è Configurar Equipos</button>
                                        <button onClick={exportTasksReport} className="bg-white border border-slate-300 hover:border-brand-500 text-slate-700 hover:text-brand-600 px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2 shadow-sm">üìã Reporte Tareas</button>
                                    </div>
                                </div>
                                <div className="flex gap-6 border-b border-slate-200 mb-6 justify-between">
                                    <div className="flex gap-6">
                                        <button onClick={() => setView('TABLE')} className={`pb-3 font-bold text-sm transition-colors border-b-2 px-2 ${view === 'TABLE' ? 'text-brand-600 border-brand-600' : 'text-slate-500 border-transparent hover:text-slate-700'}`}>üìä Tabla Cobertura</button>
                                        <button onClick={() => setView('MISSING')} className={`pb-3 font-bold text-sm transition-colors border-b-2 px-2 ${view === 'MISSING' ? 'text-red-600 border-red-600' : 'text-slate-500 border-transparent hover:text-slate-700'}`}>‚ö†Ô∏è Faltantes (Oportunidades)</button>
                                        <button onClick={() => setView('POLICY')} className={`pb-3 font-bold text-sm transition-colors border-b-2 px-2 ${view === 'POLICY' ? 'text-purple-600 border-purple-600' : 'text-slate-500 border-transparent hover:text-slate-700'}`}>ü§ñ An√°lisis Pol√≠tica AI</button>
                                    </div>
                                    {view === 'TABLE' && (
                                        <button onClick={() => exportCoverageTable(tableData)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded shadow-sm font-bold text-xs flex items-center gap-2 mb-2">
                                            üì• Descargar Tabla
                                        </button>
                                    )}
                                </div>
                                
                                {view === 'POLICY' && <PolicyAnalyzer parque={park} productsByModelId={processed.prodMap} availableTeams={availableTeams} />}
                                
                                {view === 'TABLE' && (
                                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden h-[70vh] relative">
                                        <div className="absolute top-0 left-0 w-full h-full overflow-auto custom-scrollbar">
                                            <table className="min-w-full text-sm text-left border-collapse">
                                                <thead className="bg-slate-50 text-slate-600 font-semibold sticky top-0 z-20 shadow-sm">
                                                    <tr>
                                                        <th className="p-3 sticky left-0 bg-slate-50 z-30 border-b border-r min-w-[140px]">Marca</th>
                                                        <th className="p-3 sticky left-[140px] bg-slate-50 z-30 border-b border-r min-w-[260px]">Modelo</th>
                                                        {tableData.cols.map(c => <th key={c} className="p-2 text-center border-b min-w-[100px]"><div className="text-[10px] text-brand-600 font-bold uppercase">{c.split('|')[0] === 'ALL' ? '' : c.split('|')[0]}</div><div className="text-xs">{c.split('|')[1] === 'ALL' ? 'Total' : c.split('|')[1]}</div></th>)}
                                                        <th className="p-3 text-center border-b bg-slate-100 font-bold">Total</th>
                                                        <th className="p-3 border-b bg-slate-50 font-bold min-w-[200px]">Comentarios Estrat√©gicos</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {Object.keys(tableData.res).sort().map(br => (
                                                        <React.Fragment key={br}>
                                                            {tableData.res[br].sort((a, b) => (a.Orden || 999) - (b.Orden || 999)).map((m, i) => (
                                                                <tr key={i} className="hover:bg-slate-50 transition-colors group">
                                                                    {i === 0 && <td rowSpan={tableData.res[br].length} className="p-3 font-bold sticky left-0 bg-white border-r border-b align-top text-slate-700 z-10">{br}</td>}
                                                                    <td className="p-3 sticky left-[140px] bg-white border-r border-b text-slate-600 z-10 group-hover:bg-slate-50 transition-colors">{m.MODELO}</td>
                                                                    {tableData.cols.map(c => (<td key={c} className="p-2 text-center border-b border-r border-slate-50">{m.counts[c] > 0 ? <button onClick={() => setModalData({ marca: br, modelo: m.MODELO, columna: c, productos: m.prods[c] })} className="bg-brand-50 text-brand-700 hover:bg-brand-100 hover:scale-110 px-3 py-1 rounded font-bold transition-all text-xs shadow-sm min-w-[32px]">{m.counts[c]}</button> : <span className="text-slate-200 text-[10px]">‚Ä¢</span>}</td>))}
                                                                    <td className="p-3 text-center font-bold bg-slate-50 border-b text-slate-800">{m.total}</td>
                                                                    <td className="p-2 border-b border-l bg-slate-50/30">
                                                                        <input 
                                                                            type="text" 
                                                                            placeholder="Agregar nota..." 
                                                                            className="w-full bg-transparent border-b border-transparent hover:border-slate-300 focus:border-brand-500 focus:outline-none text-xs p-1"
                                                                            value={modelComments[m.MODELO] || ''}
                                                                            onChange={(e) => handleModelCommentChange(m.MODELO, e.target.value)}
                                                                        />
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </React.Fragment>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {view === 'MISSING' && (
                                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden h-[70vh] relative">
                                        <div className="absolute top-0 left-0 w-full h-full overflow-auto custom-scrollbar">
                                            <table className="min-w-full text-sm text-left border-collapse">
                                                <thead className="bg-slate-50 text-slate-600 font-semibold sticky top-0 z-10 shadow-sm">
                                                    <tr><th className="px-6 py-3 border-b">Marca</th><th className="px-6 py-3 border-b">Modelo</th><th className="px-6 py-3 border-b text-center">Clasificaci√≥n</th><th className="px-6 py-3 border-b text-center">A√±o Desde</th><th className="px-6 py-3 border-b text-center">A√±o Hasta</th><th className="px-6 py-3 border-b text-center">Parque (Unidades)</th></tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {processed.missing
                                                        .filter(m => (filtroCat === 'TODOS' || m.Clasificacion === filtroCat) && (filtroMarca === 'TODOS' || m.MARCA === filtroMarca))
                                                        .sort((a, b) => (a.Orden || 9999) - (b.Orden || 9999))
                                                        .map((modelo, idx) => (
                                                            <tr key={idx} className="hover:bg-red-50/30 transition-colors">
                                                                <td className="px-6 py-3 font-medium text-slate-700">{modelo.MARCA}</td>
                                                                <td className="px-6 py-3 text-slate-600">{modelo.MODELO}</td>
                                                                <td className="px-6 py-3 text-center"><span className="px-2 py-0.5 rounded text-xs font-bold bg-slate-100 text-slate-600">{modelo.Clasificacion}</span></td>
                                                                <td className="px-6 py-3 text-center text-slate-500">{modelo.DESDE}</td>
                                                                <td className="px-6 py-3 text-center text-slate-500">{modelo.HASTA}</td>
                                                                <td className="px-6 py-3 text-center font-mono text-slate-600">{modelo.Parque ? modelo.Parque.toLocaleString() : '-'}</td>
                                                            </tr>
                                                        ))
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                        {modalData && <ProductModal data={modalData} availableTeams={availableTeams} onClose={() => setModalData(null)} />}
                        {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
                        {showTeamsConfig && <TeamsConfigModal currentTeams={availableTeams} onSave={updateTeams} onClose={() => setShowTeamsConfig(false)} />}
                        <VoiceAssistant />
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>